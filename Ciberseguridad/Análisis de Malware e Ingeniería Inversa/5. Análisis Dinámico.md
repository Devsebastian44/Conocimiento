# Introducción al Análisis Dinámico

El análisis dinámico es una técnica fundamental en el análisis de malware que implica la ejecución del malware en un entorno controlado para observar su comportamiento en tiempo real. A diferencia del análisis estático, que examina el código sin ejecutarlo, el análisis dinámico nos permite comprender las acciones reales que el malware realiza cuando está activo.

## Características del Análisis Dinámico

- **Ejecución en tiempo real**: El malware se ejecuta en un entorno controlado
- **Observación del comportamiento**: Se monitorizan las acciones del malware
- **Análisis de interacciones**: Se estudian las interacciones con el sistema operativo
- **Detección de técnicas de evasión**: Se identifican mecanismos anti-análisis

## Ventajas del Análisis Dinámico

1. **Revelación de funcionalidad oculta**: Detecta comportamientos que no son evidentes en el análisis estático
2. **Bypass de ofuscación**: Permite ver el código después de que se desofusque
3. **Análisis de comunicaciones**: Observa las comunicaciones de red del malware
4. **Identificación de persistencia**: Detecta cómo el malware mantiene su persistencia

## Desafíos del Análisis Dinámico

- **Entornos sandbox**: El malware puede detectar entornos virtualizados
- **Tiempo de ejecución**: Algunos malware tienen temporizadores o condiciones específicas
- **Técnicas anti-análisis**: El malware puede implementar mecanismos de evasión
- **Complejidad del análisis**: Requiere herramientas y conocimientos especializados


# Process Monitoring - Monitoreo de Procesos

El monitoreo de procesos es la base del análisis dinámico, permitiendo observar qué procesos crea, modifica o termina el malware.

## Herramientas de Monitoreo de Procesos

### Process Monitor (ProcMon)

- **Desarrollador**: Microsoft Sysinternals
- **Función**: Monitorea en tiempo real el sistema de archivos, registro y actividad de procesos
- **Ventajas**: Interfaz gráfica intuitiva, filtros avanzados, captura detallada

### Process Explorer

- **Función**: Proporciona información detallada sobre procesos en ejecución
- **Características**:
    - Vista jerárquica de procesos
    - Información sobre handles y DLLs
    - Verificación de firmas digitales
    - Detección de procesos maliciosos

### API Monitor

- **Función**: Monitorea las llamadas a la API de Windows
- **Características**:
    - Interceptación de llamadas API
    - Análisis de parámetros y valores de retorno
    - Breakpoints en llamadas específicas

## Técnicas de Monitoreo

### Creación de Procesos

```
Eventos a monitorear:
- CreateProcess
- CreateProcessAsUser
- WinExec
- ShellExecute
```

### Inyección de Procesos

```
Técnicas comunes:
- DLL Injection
- Process Hollowing
- Reflective DLL Loading
- Process Doppelgänging
```

### Análisis de Memoria

```
Aspectos a examinar:
- Asignación de memoria
- Protección de memoria
- Contenido de memoria
- Patrones de acceso
```

## Configuración de ProcMon

1. **Filtros básicos**:
    - Filtrar por nombre del proceso
    - Filtrar por tipo de operación
    - Excluir procesos del sistema
2. **Configuración avanzada**:
    - Habilitar captura de stack traces
    - Configurar símbolos de depuración
    - Establecer límites de captura


# Registry Analysis - Análisis del Registro

El registro de Windows es un objetivo común para el malware, ya que permite establecer persistencia y modificar la configuración del sistema.

## Claves de Registro Críticas

### Autostart Locations

```
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

### Servicios del Sistema

```
HKLM\System\CurrentControlSet\Services
HKLM\System\CurrentControlSet\Control\SafeBoot
```

### Configuración de Seguridad

```
HKLM\Software\Microsoft\Windows\CurrentVersion\Policies
HKCU\Software\Microsoft\Windows\CurrentVersion\Policies
HKLM\Software\Policies\Microsoft\Windows Defender
```

## Herramientas de Análisis del Registro

### RegShot

- **Función**: Toma snapshots del registro para comparar cambios
- **Uso**:
    1. Tomar snapshot antes de la ejecución
    2. Ejecutar el malware
    3. Tomar segundo snapshot
    4. Comparar diferencias

### Registry Editor (regedit)

- **Función**: Navegación manual del registro
- **Técnicas**:
    - Búsqueda de claves específicas
    - Exportación de claves
    - Monitoreo de cambios

### Autoruns

- **Función**: Muestra programas configurados para ejecutarse automáticamente
- **Características**:
    - Vista completa de autostart locations
    - Verificación de firmas digitales
    - Ocultación de entradas de Microsoft

## Técnicas de Persistencia en el Registro

### Run Keys

```
Descripción: Ejecuta programas al iniciar Windows
Ubicación: HKCU/HKLM\...\Run
Detección: Monitorear cambios en estas claves
```

### Services

```
Descripción: Instala servicios del sistema
Ubicación: HKLM\System\CurrentControlSet\Services
Detección: Nuevos servicios o modificaciones
```

### Image File Execution Options

```
Descripción: Redirige la ejecución de programas
Ubicación: HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
Uso malicioso: Hijacking de procesos legítimos
```

# Network Activity Analysis - Análisis de Actividad de Red

El análisis de red es crucial para entender las comunicaciones del malware, incluyendo C&C (Command and Control) y exfiltración de datos.

## Herramientas de Análisis de Red

### Wireshark

- **Función**: Captura y análisis de paquetes de red
- **Características**:
    - Captura en tiempo real
    - Análisis de protocolos
    - Filtros avanzados
    - Seguimiento de flujos

### TCPView

- **Función**: Muestra conexiones TCP/UDP en tiempo real
- **Información mostrada**:
    - Proceso propietario
    - Direcciones locales y remotas
    - Estado de la conexión
    - Puertos utilizados

### Netstat

- **Función**: Herramienta de línea de comandos para estadísticas de red
- **Comandos útiles**:

```cmd
netstat -ano    # Mostrar todas las conexiones con PIDs
netstat -b      # Mostrar ejecutables asociados
netstat -r      # Mostrar tabla de enrutamiento
```

## Patrones de Comunicación Maliciosa

### Comunicaciones C&C

```
Características:
- Conexiones periódicas a IPs específicas
- Uso de puertos no estándar
- Comunicación cifrada o ofuscada
- Beaconing patterns
```

### Exfiltración de Datos

```
Indicadores:
- Transferencias de datos inusuales
- Conexiones a servicios de almacenamiento
- Uso de protocolos de túnel
- Volúmenes de datos anómalos
```

### DNS Tunneling

```
Técnica: Uso de consultas DNS para comunicación
Detección: Consultas DNS anómalas o excesivas
Herramientas: Análisis de logs DNS
```

## Configuración de Wireshark para Análisis de Malware

1. **Filtros básicos**:

```
ip.addr == [IP_ADDRESS]         # Filtrar por dirección IP
tcp.port == [PORT]              # Filtrar por puerto TCP
dns                             # Solo tráfico DNS
http                            # Solo tráfico HTTP
```

2. **Análisis de protocolos**:
    - Decodificación de protocolos
    - Seguimiento de flujos TCP
    - Extracción de objetos HTTP
    - Análisis de certificados SSL/TLS


# File Changes Monitoring - Monitoreo de Cambios en Archivos

El monitoreo de cambios en archivos permite detectar qué archivos crea, modifica o elimina el malware.

## Herramientas de Monitoreo de Archivos

### Process Monitor (ProcMon)

- **Función**: Monitorea operaciones del sistema de archivos
- **Operaciones monitoreadas**:
    - CreateFile
    - WriteFile
    - ReadFile
    - DeleteFile
    - SetFileAttributes

### File Monitor (FileMon)

- **Función**: Herramienta legacy para monitoreo de archivos
- **Nota**: Reemplazada por Process Monitor

### SysInternals Suite

- **Herramientas incluidas**:
    - Process Monitor
    - Process Explorer
    - TCPView
    - Autoruns
    - PsExec

## Ubicaciones Críticas de Archivos

### Directorios del Sistema

```
%SystemRoot%\System32\
%SystemRoot%\SysWOW64\
%SystemRoot%\
%ProgramFiles%\
%ProgramFiles(x86)%\
```

### Directorios de Usuario

```
%APPDATA%\
%LOCALAPPDATA%\
%TEMP%\
%USERPROFILE%\
%USERPROFILE%\Documents\
```

### Directorios de Inicio

```
%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\
%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup\
```

## Técnicas de Evasión de Archivos

### Archivos Ocultos

```
Técnicas:
- Atributos de archivo oculto
- Nombres de archivo especiales
- Alternate Data Streams (ADS)
- Ubicaciones no convencionales
```

### Timestomping

```
Descripción: Modificación de timestamps de archivos
Propósito: Evadir detección forense
Detección: Análisis de metadatos de archivos
```

### File Encryption

```
Técnica: Cifrado de archivos maliciosos
Propósito: Evadir detección por AV
Análisis: Decryption en tiempo de ejecución
```


# Sandboxes - Entornos de Análisis Automatizado

Los sandboxes son entornos automatizados que ejecutan malware y generan informes de comportamiento.

## Tipos de Sandboxes

### Sandboxes Online

- **Ventajas**: Fácil acceso, sin configuración
- **Desventajas**: Limitaciones de privacidad, detección por malware

### Sandboxes Locales

- **Ventajas**: Control total, privacidad
- **Desventajas**: Requiere configuración y mantenimiento

### Sandboxes Comerciales

- **Ventajas**: Análisis avanzado, soporte técnico
- **Desventajas**: Costo, dependencia de terceros

## Sandboxes Populares

### Cuckoo Sandbox

- **Tipo**: Open source
- **Características**:
    - Análisis automatizado
    - Soporte para múltiples sistemas operativos
    - API REST para integración
    - Informes detallados

### Any.run

- **Tipo**: Online/Commercial
- **Características**:
    - Análisis en tiempo real
    - Interacción con el malware
    - Múltiples sistemas operativos
    - Análisis de redes

### Joe Sandbox

- **Tipo**: Commercial
- **Características**:
    - Análisis avanzado
    - Detección de evasión
    - Análisis de código
    - Integración con SIEM

### Hybrid Analysis

- **Tipo**: Online (Falcon Sandbox)
- **Características**:
    - Análisis gratuito limitado
    - Múltiples engines de análisis
    - Inteligencia de amenazas
    - API para automatización

## Configuración de Sandbox

### Requisitos del Sistema

```
Componentes necesarios:
- Máquina virtual aislada
- Herramientas de monitoreo
- Captura de red
- Almacenamiento de resultados
```

### Configuración de Red

```
Opciones:
- Aislamiento completo
- Internet simulado
- Honeypot integration
- Traffic analysis
```

### Configuración del Sistema Operativo

```
Aspectos importantes:
- Versión del OS
- Parches de seguridad
- Software instalado
- Configuración de usuario
```

## Evasión de Sandboxes

### Técnicas de Detección

```
Métodos comunes:
- Detección de virtualización
- Análisis de temporización
- Detección de herramientas de análisis
- Verificación de interacción humana
```

### Contramedidas

```
Estrategias:
- Emulación de entorno real
- Interacción manual
- Modificación de artifacts
- Múltiples análisis
```

# Metodología de Análisis Dinámico

## Preparación del Entorno

1. **Aislamiento de red**:
    - Configurar VLAN aislada
    - Implementar IDS/IPS
    - Configurar proxy para análisis
2. **Configuración del sistema**:
    - Snapshot del estado limpio
    - Instalación de herramientas
    - Configuración de monitoreo
3. **Preparación de herramientas**:
    - Process Monitor
    - Wireshark
    - RegShot
    - Autoruns

## Proceso de Análisis

### Fase 1: Captura del Estado Inicial

```
Acciones:
1. Tomar snapshot del sistema
2. Ejecutar RegShot (primera captura)
3. Iniciar Process Monitor
4. Iniciar captura de red
```

### Fase 2: Ejecución del Malware

```
Acciones:
1. Ejecutar la muestra de malware
2. Observar comportamiento inmediato
3. Permitir ejecución por tiempo definido
4. Interactuar si es necesario
```

### Fase 3: Análisis Post-Ejecución

```
Acciones:
1. Detener captura de herramientas
2. Tomar RegShot (segunda captura)
3. Analizar cambios en el sistema
4. Examinar comunicaciones de red
```

## Análisis de Resultados

### Cambios en el Sistema

```
Aspectos a revisar:
- Procesos creados/modificados
- Archivos creados/modificados
- Cambios en el registro
- Servicios instalados
```

### Comunicaciones de Red

```
Análisis incluye:
- Direcciones IP contactadas
- Puertos utilizados
- Protocolos empleados
- Datos transferidos
```

### Persistencia

```
Mecanismos comunes:
- Modificación de registry
- Creación de servicios
- Archivos en startup
- Tareas programadas
```

# Herramientas Avanzadas

## Debuggers

- **x64dbg**: Debugger de código nativo
- **OllyDbg**: Debugger para análisis de malware
- **WinDbg**: Debugger oficial de Microsoft

## Análisis de Memoria

- **Volatility**: Framework de análisis forense de memoria
- **Rekall**: Herramienta de análisis de memoria
- **Memoryze**: Herramienta de FireEye

## Análisis de Red

- **NetworkMiner**: Analizador de tráfico de red
- **Snort**: Sistema de detección de intrusos
- **Suricata**: Engine de detección de amenazas

# Consideraciones de Seguridad

## Aislamiento

- Usar máquinas virtuales aisladas
- Implementar segmentación de red
- Configurar snapshots para recuperación rápida

## Backup y Recuperación

- Mantener snapshots limpios
- Implementar procedimientos de recuperación
- Documentar configuraciones

## Manejo de Muestras

- Almacenamiento seguro de muestras
- Controles de acceso
- Procedimientos de eliminación