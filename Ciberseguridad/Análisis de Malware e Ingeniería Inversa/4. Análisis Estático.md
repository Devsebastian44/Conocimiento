# Uso de VirusTotal e Intezer

## VirusTotal

**¿Qué es VirusTotal?**

- Servicio web gratuito de Google
- Analiza archivos y URLs con múltiples antivirus
- Proporciona información detallada sobre detecciones

**Características principales**:

- Análisis con 70+ motores antivirus
- Análisis de comportamiento
- Información de metadatos
- Relaciones entre archivos
- Grafos de comunicación

**Uso de VirusTotal**:

1. **Análisis de archivo**:
    - Subir archivo (máximo 650MB)
    - Esperar resultados de análisis
    - Revisar detecciones y comportamiento
2. **Análisis de hash**:
    - Buscar por MD5, SHA1, SHA256
    - Verificar si ya fue analizado
    - Revisar historial de detecciones
3. **Información adicional**:
    - Pestaña "Details": Metadatos del archivo
    - Pestaña "Relations": Archivos relacionados
    - Pestaña "Behavior": Análisis dinámico
    - Pestaña "Community": Comentarios de usuarios

**Ejemplo de consulta por API**:

```python
import requests
import json

api_key = "tu_api_key_aqui"
url = "https://www.virustotal.com/vtapi/v2/file/report"

params = {
    'apikey': api_key,
    'resource': 'hash_del_archivo'
}

response = requests.get(url, params=params)
result = response.json()

print(f"Detecciones: {result['positives']}/{result['total']}")
```

## Intezer

**¿Qué es Intezer?**

- Plataforma de análisis de malware basada en "code reuse"
- Identifica similitudes de código entre muestras
- Proporciona análisis de familias de malware

**Características principales**:

- Análisis de reutilización de código
- Identificación de familias de malware
- Análisis de memoria
- Detección de código legítimo vs malicioso

**Uso de Intezer**:

1. Subir archivo para análisis
2. Revisar clasificación (malware, trusted, suspicious)
3. Analizar genes de código identificados
4. Revisar familias de malware relacionadas

## Análisis de Hash y Strings

### Análisis de Hash

**Tipos de Hash**:

- **MD5**: 32 caracteres hexadecimales
- **SHA1**: 40 caracteres hexadecimales
- **SHA256**: 64 caracteres hexadecimales

**Herramientas para calcular hash**:

```bash
# Linux
md5sum archivo.exe
sha1sum archivo.exe
sha256sum archivo.exe

# Windows PowerShell
Get-FileHash archivo.exe -Algorithm MD5
Get-FileHash archivo.exe -Algorithm SHA1
Get-FileHash archivo.exe -Algorithm SHA256
```

**Importancia del Hash**:

- Identificación única del archivo
- Detección de modificaciones
- Consulta en bases de datos de malware
- Creación de IoCs (Indicators of Compromise)

### Análisis de Strings

**¿Qué son las Strings?**

- Secuencias de caracteres legibles en el archivo
- Pueden revelar funcionalidad del malware
- Incluyen URLs, nombres de archivos, comandos

**Herramientas para extraer strings**:

1. **Strings (Sysinternals)**:

```cmd
strings.exe -a archivo.exe > strings.txt
```

2. **FLOSS (FireEye)**:
 
```cmd
floss.exe archivo.exe > floss_output.txt
```

3. **BinText**:
    - Interfaz gráfica para análisis de strings
    - Filtros por tipo de string
    - Búsqueda y resaltado

**Tipos de Strings Importantes**:

- **URLs y dominios**: Comunicación C&C
- **Nombres de archivos**: Archivos que crea/modifica
- **Claves de registro**: Persistencia
- **Comandos**: Funcionalidad del malware
- **Mensajes de error**: Información del desarrollador

**Ejemplo de análisis de strings**:

```
Strings encontradas:
- http://malware.evil.com/gate.php
- SOFTWARE\Microsoft\Windows\CurrentVersion\Run
- %APPDATA%\Microsoft\Windows\
- cmd.exe /c del
- Your files have been encrypted
```

## Empaquetado de Malware (Malware Packing)

### ¿Qué es el Packing?

- Técnica para comprimir y/o cifrar ejecutables
- Dificulta el análisis estático
- Reduce el tamaño del archivo
- Evade detección por antivirus

### Tipos de Packers

1. **Packers legítimos**:
    - UPX: Packer de compresión
    - ASPack: Packer comercial
    - PECompact: Packer de compresión
2. **Packers maliciosos**:
    - Cryptors: Cifrado del payload
    - Protectors: Protección anti-análisis
    - Custom packers: Desarrollados por malware authors

### Detección de Packers

**Herramientas de detección**:

1. **PEiD**:
    - Base de datos de firmas de packers
    - Interfaz gráfica simple
    - Detección automática
2. **Detect It Easy (DIE)**:
    - Detector moderno de packers
    - Soporte para múltiples formatos
    - Análisis heurístico
3. **ExeinfoPE**:
    - Información detallada del PE
    - Detección de packers y protectores
    - Análisis de entropy

**Indicadores de archivos empaquetados**:

- Alta entropía del archivo
- Pocas imports visibles
- Secciones con nombres inusuales
- Punto de entrada en sección de código comprimido

### Desempaquetado

**Técnicas de desempaquetado**:

1. **Desempaquetado automático**:
    - Herramientas específicas por packer
    - UPX: `upx -d archivo.exe`
    - Malware Unpack: Herramientas automatizadas
2. **Desempaquetado manual**:
    - Análisis dinámico hasta Original Entry Point (OEP)
    - Volcado de memoria cuando se desempaqueta
    - Reconstrucción del archivo
3. **Desempaquetado con debugger**:
    - Usar x64dbg o OllyDbg
    - Seguir ejecución hasta OEP
    - Dumping del proceso desempaquetado

## Análisis de Cabeceras PE

### Estructura del formato PE

**Componentes principales**:

- **DOS Header**: Compatibilidad con MS-DOS
- **PE Header**: Información principal del PE
- **Section Headers**: Información de secciones
- **Sections**: Código, datos, recursos

### Análisis de DOS Header

```
Offset   Size   Field
0x00     2      e_magic (MZ)
0x02     2      e_cblp
0x04     2      e_cp
...
0x3C     4      e_lfanew (offset to PE header)
```

### Análisis de PE Header

**IMAGE_FILE_HEADER**:

- **Machine**: Arquitectura del procesador
- **NumberOfSections**: Número de secciones
- **TimeDateStamp**: Fecha de compilación
- **Characteristics**: Características del archivo

**IMAGE_OPTIONAL_HEADER**:

- **AddressOfEntryPoint**: Punto de entrada
- **ImageBase**: Dirección base de carga
- **SectionAlignment**: Alineación de secciones
- **Subsystem**: Tipo de aplicación (GUI, Console, etc.)

### Herramientas para análisis PE

1. **PE-bear**:
    - Visor gráfico de estructura PE
    - Análisis de imports/exports
    - Detección de anomalías
2. **CFF Explorer**:
    - Editor hexadecimal integrado
    - Análisis de recursos
    - Calculadora de RVA
3. **PEview**:
    - Visor simple de estructura PE
    - Análisis de secciones
    - Información de imports

### Análisis de Secciones

**Secciones comunes**:

- **.text**: Código ejecutable
- **.data**: Datos inicializados
- **.rdata**: Datos de solo lectura
- **.rsrc**: Recursos del programa
- **.reloc**: Información de reubicación

**Indicadores de malware en secciones**:

- Secciones con nombres inusuales
- Entropía alta en secciones de datos
- Secciones ejecutables no estándar
- Solapamiento de secciones

**Ejemplo de análisis de sección**:

```
Sección: .text
- VirtualAddress: 0x1000
- VirtualSize: 0x15000
- RawSize: 0x15000
- Characteristics: 0x60000020 (CODE | EXECUTE | READ)
- Entropía: 6.2 (normal para código)
```

### Import Address Table (IAT)

**¿Qué es la IAT?**

- Tabla de direcciones de funciones importadas
- Resuelve llamadas a DLLs externas
- Indica funcionalidad del programa

**Análisis de imports importantes**:

- **kernel32.dll**: Funciones básicas del sistema
- **advapi32.dll**: Funciones de registro y servicios
- **wininet.dll**: Funciones de internet
- **ws2_32.dll**: Funciones de red

**Imports sospechosos**:

```
- CreateFile: Creación/modificación de archivos
- RegSetValue: Modificación del registro
- InternetOpen: Conexiones a internet
- CreateProcess: Ejecución de procesos
- VirtualAlloc: Allocación de memoria
```